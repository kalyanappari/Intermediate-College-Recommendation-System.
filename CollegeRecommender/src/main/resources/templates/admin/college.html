<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Manage Colleges</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      max-width: 400px;
    }
    .table-responsive {
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    .btn-group-sm > .btn {
      margin-right: 5px;
    }
  </style>
</head>
<body>

<!-- Success/Error Messages -->
<div class="alert-container">
  <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
    <strong>Success!</strong> <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Error!</strong> <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
</div>

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">College Management</h2>
    <a href="/admin/dashboard" class="btn btn-secondary">Back to Dashboard</a>
  </div>

  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#collegeModal"
          onclick="resetForm()">
    <i class="bi bi-plus-circle"></i> Add College
  </button>

  <div class="table-responsive">
    <table class="table table-bordered table-hover mb-0">
      <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Location</th>
        <th>Sector</th>
        <th>Hostel</th>
        <th>Budget</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="college : ${colleges}">
        <td th:text="${college.collegeId}">1</td>
        <td th:text="${college.name}">ABC College</td>
        <td th:text="${college.location}">City</td>
        <td th:text="${college.sector}">Government</td>
        <td>
          <span th:if="${college.hostelAvailable}" class="badge bg-success">Yes</span>
          <span th:unless="${college.hostelAvailable}" class="badge bg-danger">No</span>
        </td>
        <td th:text="${college.budgetRange != null} ? ${'₹' + #numbers.formatDecimal(college.budgetRange, 0, 'COMMA', 2, 'POINT')} : 'N/A'">₹50,000.00</td>
        <td>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-warning"
                    th:data-id="${college.collegeId}"
                    th:data-name="${college.name}"
                    th:data-location="${college.location}"
                    th:data-sector="${college.sector}"
                    th:data-hostel="${college.hostelAvailable}"
                    th:data-budget="${college.budgetRange}"
                    onclick="editCollegeFromButton(this)"
                    data-bs-toggle="modal" data-bs-target="#collegeModal">
              Edit
            </button>
            <a th:href="@{/admin/colleges/delete/{id}(id=${college.collegeId})}"
               class="btn btn-danger"
               onclick="return confirm('Are you sure you want to delete this college? This action cannot be undone.')">
              Delete
            </a>
          </div>
        </td>
      </tr>
      <tr th:if="${#lists.isEmpty(colleges)}">
        <td colspan="7" class="text-center text-muted py-4">
          No colleges found. <a href="#" data-bs-toggle="modal" data-bs-target="#collegeModal" onclick="resetForm()">Add the first college</a>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="collegeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="collegeForm" action="/admin/colleges/save" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add College</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="collegeId" name="collegeId" value="0"/>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">College Name <span class="text-danger">*</span></label>
              <input type="text" id="name" name="name" class="form-control" required
                     placeholder="Enter college name">
            </div>
            <div class="col-md-6 mb-3">
              <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
              <input type="text" id="location" name="location" class="form-control" required
                     placeholder="Enter location">
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="sector" class="form-label">Sector <span class="text-danger">*</span></label>
              <select id="sector" name="sector" class="form-select" required>
                <option value="">Select Sector</option>
                <option value="Government">Government</option>
                <option value="Private">Private</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Hostel Available</label>
              <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" id="hostelAvailable" name="hostelAvailable">
                <label class="form-check-label" for="hostelAvailable" id="hostelLabel">No</label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="budgetRange" class="form-label">Budget Range (₹)</label>
            <input type="number" id="budgetRange" name="budgetRange" class="form-control"
                   step="0.01" min="0" placeholder="Enter budget range">
            <div class="form-text">Enter the approximate annual fees</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" id="submitBtn">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Auto-dismiss alerts after 5 seconds
  setTimeout(function() {
    var alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
      var bsAlert = new bootstrap.Alert(alert);
      bsAlert.close();
    });
  }, 5000);

  // Update hostel label based on checkbox
  document.getElementById('hostelAvailable').addEventListener('change', function() {
    document.getElementById('hostelLabel').textContent = this.checked ? 'Yes' : 'No';
  });

  // College data for editing
  const colleges = {};
  // Populate colleges data from Thymeleaf
  /*[# th:each="college : ${colleges}"]*/
  colleges[/*[[${college.collegeId}]]*/ 0] = {
    id: /*[[${college.collegeId}]]*/ 0,
    name: /*[['${college.name}']] ?: ''*/ '',
    location: /*[['${college.location}']] ?: ''*/ '',
    sector: /*[['${college.sector}']] ?: ''*/ '',
    hostelAvailable: /*[[${college.hostelAvailable}]] ?: false*/ false,
    budgetRange: /*[[${college.budgetRange}]] ?: null*/ null
  };
  /*[/]*/

  console.log('Colleges data loaded:', colleges); // Debug log

  function resetForm() {
    // Form action is already set to /admin/colleges/save
    document.getElementById('modalTitle').textContent = 'Add College';
    document.getElementById('submitBtn').textContent = 'Save';

    // Reset all form fields
    document.getElementById('collegeId').value = '0';
    document.getElementById('name').value = '';
    document.getElementById('location').value = '';
    document.getElementById('sector').value = '';
    document.getElementById('hostelAvailable').checked = false;
    document.getElementById('budgetRange').value = '';
    document.getElementById('hostelLabel').textContent = 'No';
  }

  function editCollegeFromButton(button) {
    console.log('Edit button clicked'); // Debug log

    // Get data from button attributes
    const id = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');
    const location = button.getAttribute('data-location');
    const sector = button.getAttribute('data-sector');
    const hostel = button.getAttribute('data-hostel') === 'true';
    const budget = button.getAttribute('data-budget');

    console.log('Button data:', { id, name, location, sector, hostel, budget }); // Debug log

    // Update modal title and button
    document.getElementById('modalTitle').textContent = 'Edit College';
    document.getElementById('submitBtn').textContent = 'Update';

    // Populate form fields
    document.getElementById('collegeId').value = id;
    document.getElementById('name').value = name || '';
    document.getElementById('location').value = location || '';
    document.getElementById('sector').value = sector || '';

    // Handle checkbox
    const hostelCheckbox = document.getElementById('hostelAvailable');
    hostelCheckbox.checked = hostel;
    document.getElementById('hostelLabel').textContent = hostel ? 'Yes' : 'No';

    // Handle budget
    document.getElementById('budgetRange').value = budget === 'null' || !budget ? '' : budget;

    console.log('Form populated from button data'); // Debug log
  }

  function editCollege(id) {
    console.log('Editing college with ID:', id); // Debug log
    const college = colleges[id];
    console.log('College data:', college); // Debug log

    if (college) {
      // Form action remains the same - /admin/colleges/save
      document.getElementById('modalTitle').textContent = 'Edit College';
      document.getElementById('submitBtn').textContent = 'Update';

      // Populate form fields
      document.getElementById('collegeId').value = college.id;
      document.getElementById('name').value = college.name || '';
      document.getElementById('location').value = college.location || '';
      document.getElementById('sector').value = college.sector || '';

      // Handle checkbox properly
      const hostelCheckbox = document.getElementById('hostelAvailable');
      hostelCheckbox.checked = college.hostelAvailable === true;
      document.getElementById('hostelLabel').textContent = college.hostelAvailable ? 'Yes' : 'No';

      // Handle budget range
      document.getElementById('budgetRange').value = college.budgetRange || '';

      console.log('Form populated successfully'); // Debug log
    } else {
      console.error('College not found with ID:', id);
      alert('College data not found!');
    }
  }

  // Show modal if editing
  /*[# th:if="${isEdit}"]*/
  document.addEventListener('DOMContentLoaded', function() {
    const collegeId = /*[[${college.collegeId}]]*/ 0;
    if (collegeId > 0) {
      editCollege(collegeId);
      new bootstrap.Modal(document.getElementById('collegeModal')).show();
    }
  });
  /*[/]*/
</script>
</body>
</html>